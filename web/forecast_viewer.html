<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Financial Forecast Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      max-height: 100vh;
    }
    header {
      padding: 16px 24px;
      border-bottom: 1px solid #1f2937;
      background: #020617;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px 24px 24px;
      gap: 16px;
      min-height: 0;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .file-input {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #111827;
      border-radius: 8px;
      border: 1px solid #1f2937;
      cursor: pointer;
      font-size: 14px;
    }
    .file-input input[type="file"] {
      display: none;
    }
    .select {
      background: #020617;
      border-radius: 6px;
      border: 1px solid #1f2937;
      padding: 6px 10px;
      color: #e5e7eb;
      font-size: 13px;
    }
    .badge {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #0b1120;
      color: #9ca3af;
    }
    #status {
      font-size: 12px;
      color: #9ca3af;
    }
    #chart-container {
      flex: 1;
      min-height: 0;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, #1f2937 0, #020617 55%, #020617 100%);
      padding: 16px 16px 8px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
      flex: 1;
    }
    #style-legend {
      display: flex;
      gap: 16px;
      align-items: center;
      font-size: 11px;
      color: #e5e7eb;
      justify-content: center;
    }
    .style-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .style-line {
      width: 28px;
      height: 0;
      border-top: 2px solid #ffffff;
    }
    .style-line.dashed {
      border-top-style: dashed;
    }
    footer {
      padding: 8px 24px 16px;
      font-size: 11px;
      color: #6b7280;
      border-top: 1px solid #1f2937;
      background: #020617;
    }
    @media (max-width: 640px) {
      main {
        padding: 12px 12px 16px;
      }
      header, footer {
        padding: 10px 12px;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <h1>Financial Forecast Viewer</h1>
    <span class="badge">CSV → Interactive Chart</span>
  </header>

  <main>
    <div class="controls">
      <label>
        <span style="font-size: 12px; color: #9ca3af; margin-right: 6px;">Company:</span>
        <select id="company-select" class="select"></select>
      </label>

      <span id="status">Run <code>python scripts/run_all_forecasts.py</code> once, then this page will auto-load all forecasts from <code>data/forecast-results/all_forecasts.json</code>.</span>
    </div>

    <div id="chart-container">
      <canvas id="chart"></canvas>
      <div id="style-legend">
        <div class="style-item">
          <div class="style-line"></div>
          <span>Historical</span>
        </div>
        <div class="style-item">
          <div class="style-line dashed"></div>
          <span>Forecast</span>
        </div>
      </div>
    </div>
  </main>

  <footer>
    Open this file via a local server (e.g. <code>python -m http.server</code> in the project root). Forecasts are read from <code>data/forecast-results/all_forecasts.json</code>.
  </footer>

  <script>
    const statusEl = document.getElementById("status");
    const companySelect = document.getElementById("company-select");
    const ctx = document.getElementById("chart").getContext("2d");

    let chart;
    let allRecords = null;

    const metricColors = {};
    const colorPalette = [
      "#38bdf8", // sky
      "#f97316", // orange
      "#22c55e", // green
      "#a855f7", // purple
      "#eab308", // amber
      "#f43f5e", // rose
      "#0ea5e9", // light blue
      "#84cc16", // lime
      "#ec4899", // pink
      "#14b8a6", // teal
    ];
    function getColorForMetric(metric) {
      if (!metricColors[metric]) {
        const keys = Object.keys(metricColors);
        metricColors[metric] = colorPalette[keys.length % colorPalette.length];
      }
      return metricColors[metric];
    }

    function buildSeriesFromRecord(rec) {
      const year = rec.year;
      const val = rec.value;
      const isForecast = rec.is_forecast;
      if (val == null || year == null) return null;

      const kind = isForecast ? "forecast" : "historical";
      return { x: year, y: val, kind };
    }

    async function loadAllForecasts() {
      if (allRecords) return allRecords;
      const res = await fetch("../data/forecast-results/all_forecasts.json");
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      allRecords = await res.json();
      return allRecords;
    }

    function populateCompanyOptions(records) {
      const labels = Array.from(new Set(records.map(r => r.label))).sort();
      companySelect.innerHTML = "";
      labels.forEach((label, idx) => {
        const opt = document.createElement("option");
        opt.value = label;
        opt.textContent = label;
        companySelect.appendChild(opt);
      });
      if (labels.length > 0) {
        companySelect.value = labels[0];
      }
    }

    async function createMultiChart() {
      if (chart) {
        chart.destroy();
      }

      const records = await loadAllForecasts();

      if (companySelect.options.length === 0) {
        populateCompanyOptions(records);
      }

      const selectedCompany = companySelect.value;
      const filtered = records.filter(r => r.label === selectedCompany);

      const datasets = [];

      const byKey = {};
      for (const r of filtered) {
        const key = r.metric;
        if (!byKey[key]) byKey[key] = [];
        const p = buildSeriesFromRecord(r);
        if (p) byKey[key].push(p);
      }

      Object.entries(byKey).forEach(([metric, points]) => {
        if (!points.length) return;

        const histPoints = points.filter(p => p.kind === "historical");
        const fcPoints = points.filter(p => p.kind === "forecast");

        const color = getColorForMetric(metric);

        if (histPoints.length) {
          datasets.push({
            label: `${metric.replace(/_/g, " ")}`,
            data: histPoints,
            parsing: false,
            borderColor: color,
            backgroundColor: color,
            borderWidth: 1.6,
            tension: 0.25,
            pointRadius: 2.3,
            pointHoverRadius: 4,
          });
        }

        if (fcPoints.length) {
          datasets.push({
            label: `${metric.replace(/_/g, " ")} (forecast)`,
            data: fcPoints,
            parsing: false,
            borderColor: color,
            backgroundColor: color,
            borderDash: [6, 4],
            borderWidth: 1.6,
            tension: 0.25,
            pointRadius: 2.3,
            pointHoverRadius: 4,
          });
        }
      });

      const titleText = `Forecasts for all metrics – ${selectedCompany}`;

      chart = new Chart(ctx, {
        type: "line",
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "nearest",
            intersect: false,
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                color: "#e5e7eb",
                font: { size: 12 },
                padding: 12,
                usePointStyle: true,
                pointStyle: 'line',
                filter: function(item, chart) {
                  return !item.text.includes('(forecast)');
                },
              },
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const v = context.parsed.y;
                  return `${context.dataset.label}: ${v.toFixed(4)}`;
                },
              },
            },
            title: {
              display: true,
              text: titleText,
              color: "#e5e7eb",
              font: { size: 14, weight: "600" },
            },
          },
          scales: {
            x: {
              type: "linear",
              ticks: { color: "#9ca3af", precision: 0 },
              grid: { color: "rgba(31,41,55,0.6)" },
            },
            y: {
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(31,41,55,0.4)" },
            },
          },
        },
      });

      statusEl.textContent = `Loaded ${records.length} records from all_forecasts.json. Showing ${selectedCompany}.`;
    }

    (async () => {
      try {
        await createMultiChart();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Could not load data/forecast-results/all_forecasts.json. Run the Python script first.";
      }
    })();

    companySelect.addEventListener("change", () => {
      createMultiChart().catch(err => {
        console.error(err);
        statusEl.textContent = "Failed to update chart.";
      });
    });
  </script>
</body>
</html>


